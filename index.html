<html>

<head>
    <title>Project 2</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="project2.css"></link>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="d3.legend.js"></script>
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <p class="navbar-brand" href="#">Project2</p>
                <a class="navbar-brand" href="#Vis1">Vis1</a>
                <a class="navbar-brand" href="#Vis2">Vis2</a>
                <a class="navbar-brand" href="#Vis3">Vis3</a>
            </div>
        </div>
    </nav>
    <div class="w3-content" style="max-width:2000px;margin-top:70px">
        <div class="title" id="Vis1">
            <h1>Visualization 1: </h1>
            <h2>Relationship between High School Scores and GPA</h2>
            <br>
            <select id="gender">
                <option value="0">Male</option>
                <option value="1">Female</option>
            </select>
            <select id="x_factor">
                <option value="0">SAT</option>
                <option value="1">ACT Math</option>
                <option value="2">HSGPA</option>
            </select>
            <button id="compare_btn" type="button" class="btn btn-default">Compare with Female</button>
            <br>
            <div class="row">
                <div id="vis1_plot" class="column left"></div>
                <h2> Correlation </h2>
                <div id="vis1_cor" class="column right"></div>
            </div>
        </div>
        <div class="title" id="Vis2">
            <h1>Visualization 2: </h1>
            <h2>Female and Male GPA Difference in Institution w/ Extentsion Service or w/o Extentsion Service</h2>
            <div id="vis2_plot">
            </div>
        </div>
        <div class="title" id="Vis3">
            <h1>Visualization 3: </h1>
            <h2>Average Retention</h2>
            <div id="vis3_plot">
            </div>
            <div id="vis3_detail">
                <center>
                    <button id="back_btn" type="button" class="btn btn-default">Back</button>
                </center>
                <div id="vis3_detail_plot">
                </div>
            </div>
        </div>
        <div class="title" id="Vis4">
            <h1>Visualization 4: </h1>
            <h2>Race Distrubution</h2>
            <div id="vis4_plot">
            </div>
        </div>
        <script>
        //Vis1
        vis1(0, 0)
        var xfactor_select = document.getElementById("x_factor");
        var gender_select = document.getElementById("gender");

        xfactor_select.addEventListener("change", function(d) {
            // add an event listener to trigger the polt changes
            vis1(xfactor_select.value, gender_select.value);
        });
        gender_select.addEventListener("change", function(d) {
            // add an event listener to trigger the polt changes
            vis1(xfactor_select.value, gender_select.value);
            (gender_select.value == 0) ? $("#compare_btn").text("Compare with Female"): $("#compare_btn").text("Compare with Male");
        });

        function vis1(xfactor, gender) {
            var div = document.getElementById('vis1_plot');
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }
            var div2 = document.getElementById('vis1_cor');
            while (div2.firstChild) {
                div2.removeChild(div2.firstChild);
            }
            var fields = [
                ["Enroll, Male: Avg. SAT Math Score (Enrl M)", "Enroll, Male: Avg. ACT Math Score (Enrl M)", "Enroll, Male: Average HS GPA (Enrl M)"],
                ["Enroll, Female: Avg. SAT Math Score (Enrl F)", "Enroll, Female: Avg. ACT Math Score (Enrl F)", "Enroll, Female: Average HS GPA (Enrl F)"]
            ];
            var gpas = ['Freshmen, Male: Cumulative GPA (Fshm M)', 'Freshmen, Female: Cumulative GPA (Fshm F)'];
            var range = [
                [300, 1000],
                [10, 40],
                [2, 5]
            ];
            var xfactor_title = ["SAT", "ACT Math", "HSGPA"];
            var margin = { top: 20, right: 20, bottom: 30, left: 40 },
                width = 760 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            var xValue = function(d) { return parseFloat(d[fields[gender][xfactor]]); }, // data -> value
                xScale = d3.scaleLinear().range([0, width]);

            // setup y
            var yValue = function(d) { return parseFloat(d[gpas[gender]]); }, // data -> value
                yScale = d3.scaleLinear().range([height, 0]);

            var svg = d3.select("#vis1_plot").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var tooltip = d3.select("#vis1_plot").append("div")
                .attr("id", "toolTip");

            tooltip.style("position", "relative")
                .style("height", "auto")
                .style("font-size", "14")
                .style("background", "lightsteelblue")
                .style("padding", "5px")
                .style("border-radius", "8px")
                .style("opacity", 0);

            //load proper data file based on the selection
            d3.csv("/data/ACT_SAT_HS_FreshmenGPA.csv", function(data) {

                var xmax = d3.max(data, function(d) { return parseFloat(d[fields[gender][xfactor]]); });
                var xmin = d3.min(data, function(d) { return parseFloat(d[fields[gender][xfactor]]); });
                var ymax = d3.max(data, function(d) { return parseFloat(d[gpas[gender]]); });
                var ymin = d3.min(data, function(d) { return parseFloat(d[gpas[gender]]); });

                xScale.domain([range[xfactor][0], range[xfactor][1]]);
                yScale.domain([1, 4]);

                data.sort(function(a, b) { return a[fields[gender][xfactor]] - b[fields[gender][xfactor]] });

                // draw dots
                svg.selectAll(".dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", "dot")
                    .attr("r", 3.5)
                    .attr("cx", function(d) { return xScale(d[fields[gender][xfactor]]); })
                    .attr("cy", function(d) { return yScale(d[gpas[gender]]); })
                    .style("opacity", .9)
                    .on("mouseover", function(d) {
                        //change dot color when mouse hove over
                        dot = d3.select(this);
                        dot.style("fill", "red")
                            .attr("r", 4);

                        //show tooltip
                        tooltip.style("left", d3.mouse(this)[0] - width)
                            .style("top", d3.mouse(this)[1] - height)
                            .style("display", "inline-block")
                            .html(`${xfactor_title[xfactor]}: ${d[fields[gender][xfactor]]}</br> GPA: ${d[gpas[gender]]}`)
                            .style("opacity", .9);
                    })
                    .on("mouseout", function(d) {
                        //change back the color
                        var dot = d3.select(this);
                        dot.style('fill', 'DarkSlateBlue')
                            .attr('r', 3.5);
                        //hide tooltip
                        tooltip.style("display", "none");
                    });
                //draw x-axis
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale));
                //x-axis label
                svg.append("text")
                    .attr("class", "label")
                    .text(xfactor_select.options[xfactor_select.selectedIndex].text)
                    .attr("x", width / 2)
                    .attr("y", height + 30);

                //draw y-axis
                svg.append("g")
                    .call(d3.axisLeft(yScale));
                //y-axis label
                svg.append("text")
                    .attr("class", "label")
                    .text("GPA")
                    .attr("x", 5)
                    .attr("y", -5);

                var x = data.map(function(d) { return parseFloat(d[fields[gender][xfactor]]); });
                var y = data.map(function(d) { return parseFloat(d[gpas[gender]]); });

                var lr = linearRegression(x, y);

                var xmax = d3.max(data, function(d) { return parseFloat(d[fields[gender][xfactor]]); });
                var xmin = d3.min(data, function(d) { return parseFloat(d[fields[gender][xfactor]]); });
                var ymax = d3.max(data, function(d) { return parseFloat(d[gpas[gender]]); });
                var ymin = d3.min(data, function(d) { return parseFloat(d[gpas[gender]]); });

                svg.append("line")
                    .attr("id", "mainLine")
                    .attr("x1", xScale(0))
                    .attr("y1", yScale(lr.intercept))
                    .attr("x2", xScale(xmax))
                    .attr("y2", yScale((xmax * lr.slope) + lr.intercept))
                    .attr("class", "mainline");

                $("#compare_btn").click(function() {
                    var _x = data.map(function(d) { return parseFloat(d[fields[1 - gender][xfactor]]); });
                    var _y = data.map(function(d) { return parseFloat(d[gpas[1 - gender]]); });
                    var _xmax = d3.max(data, function(d) { return parseFloat(d[fields[1 - gender][xfactor]]); });
                    var _lr = linearRegression(_x, _y);
                    svg.append("line")
                        .attr("id", "subLine")
                        .attr("x1", xScale(0))
                        .attr("y1", yScale(_lr.intercept))
                        .attr("x2", xScale(_xmax))
                        .attr("y2", yScale((_xmax * _lr.slope) + _lr.intercept))
                        .attr("class", "subline");
                });
                correlation(lr, xfactor_title[xfactor]);
            });
        };

        function linearRegression(x, y) {
            var lr = {};
            var n = y.length;
            var r = 0;
            var rpart;
            var xmean = d3.mean(x, function(d) { return d; });
            var ymean = d3.mean(y, function(d) { return d; });
            var xstd = d3.deviation(x, function(d) { return d; });
            var ystd = d3.deviation(y, function(d) { return d; });
            for (var i = 0; i < y.length; i++) {
                rpart = (x[i] - xmean) * (y[i] - ymean) / xstd / ystd;
                var r = r + rpart;
            }
            var r1 = r / (y.length - 1)
            lr["slope"] = r1 * (ystd / xstd);
            lr["intercept"] = ymean - lr.slope * xmean;

            return lr;
        };

        function correlation(lr, field) {
            var margin = { top: 20, right: 20, bottom: 20, left: 20 },
                width = 400 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            var svg = d3.select("#vis1_cor").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);
            svg.append('circle').attr('cx', 100).attr('cy', 100).attr('r', 80)
                .style("fill", "MidnightBlue").style("opacity", "0.7");
            var minValue = 0.0011934690661702385;
            var maxValue = 0.6857280066121653;
            var new_v = (lr.slope - minValue) / (maxValue - minValue) * 100 + 20;
            //console.log(new_v);
            var y = 260 - new_v;
            svg.append('circle').attr('cx', 100).attr('cy', y).attr('r', 80)
                .style("fill", "LightSkyBlue").style("opacity", "0.7");

            svg.append("text")
                .attr("x", 200).attr("y", 100)
                .text("GPA");
            svg.append("text")
                .attr("x", 200).attr("y", y)
                .text(field);

        }
        //Vis2
        vis2();

        function vis2() {
            var margin = { top: 20, right: 20, bottom: 30, left: 60 },
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var svg = d3.select("#vis2_plot").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            d3.csv("/data/Male_Female_GPA_total.csv", function(data) {

                var diff_w = 0,
                    diff_wo = 0,
                    length_w = 0.0,
                    length_wo = 0.0;

                data.forEach(function(d) {
                    if (d["NCWIT Participant"] == "Extension Services, Academic Alliance") {
                        length_w++;
                        diff_w = parseFloat(d["Totals, Female: Cumulative GPA (Tot. F)"]) - parseFloat(d["Totals, Male: Cumulative GPA (Tot. M)"]);

                    } else {
                        length_wo++;
                        diff_wo = parseFloat(d["Totals, Female: Cumulative GPA (Tot. F)"]) - parseFloat(d["Totals, Male: Cumulative GPA (Tot. M)"]);
                    }
                });
                var showData = [
                    { "label": "With Extension Service", "value": diff_w / length_w },
                    { "label": "Without Extension Service", "value": diff_wo / length_wo }
                ];

                var x = d3.scaleBand()
                    .domain(showData.map(function(d) { return d.label; }))
                    .range([0, width])
                    .padding(0.4),

                    y = d3.scaleLinear().rangeRound([height, 0]);

                //x.domain(showData.map(function(d) { return d.label; }));
                y.domain(d3.extent(showData, function(d) {
                    return d.value;
                })).nice();

                svg.selectAll("rect.bar")
                    .data(showData)
                    .enter()
                    .append("rect")
                    .attr("class", function(d) {
                        if (d.value < 0) {
                            return "bar negative";
                        } else {
                            return "bar positive";
                        }
                    })
                    .attr("y", function(d) {

                        if (d.value > 0) {
                            return y(d.value);
                        } else {
                            return y(0);
                        }
                    })
                    .attr("x", function(d) {
                        return x(d.label);
                    })
                    .attr("width", x.bandwidth())
                    .attr("height", function(d) {
                        return Math.abs(y(d.value) - y(0));
                    })
                    .style("fill", "steelblue")
                    .on("mouseover", function(d) {
                        //change dot color when mouse hove over
                        var bar = d3.select(this);
                        bar.style("fill", "orange");




                    })
                    .on("mouseout", function(d) {
                        //change back the color
                        var bar = d3.select(this);
                        bar.style("fill", "steelblue");




                    });

                svg.append("g")
                    .call(d3.axisBottom(x))
                    .attr("transform", "translate(0," + y(0) + ")");

                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("class", "label")
                    .text("Female GPA - Male GPA")
                    .attr("x", 5)
                    .attr("y", -5);
            });

        };


        vis3();
        $("#vis3_detail").hide();
        document.getElementById("back_btn")
            .addEventListener("click", function(d) {
                $("#vis3_detail").fadeOut(500);
                vis3();
                $("#vis3_plot").fadeIn(500);
            });

        function vis3() {
            $("#vis3_plot").html("");
            var margin = { top: 20, right: 20, bottom: 30, left: 60 },
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var svg = d3.select("#vis3_plot").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            d3.csv("/data/Major_changed.csv", function(data) {
                var yearDict = {
                    "2003-2004": 0,
                    "2004-2005": 1,
                    "2005-2006": 2,
                    "2006-2007": 3,
                    "2007-2008": 4,
                    "2008-2009": 5,
                    "2009-2010": 6,
                    "2010-2011": 7,
                    "2011-2012": 8,
                    "2012-2013": 9,
                    "2013-2014": 10,
                    "2014-2015": 11,
                    "2015-2016": 12
                };
                var yearCount = new Array(13).fill(0),
                    maleRate = new Array(13).fill(0),
                    femaleRate = new Array(13).fill(0);
                data.forEach(function(d) {
                    var index = yearDict[d["School Year"]];

                    yearCount[index]++;
                    maleRate[index] += (parseFloat(d["Totals, Male: Enrolled in SAME MAJOR (Tot. M)"]) + 0.000001) / (parseFloat(d["Totals, Male: Enrolled in DIFFERENT MAJOR (Tot. M)"]) + parseFloat(d["Totals, Male: Enrolled in SAME MAJOR (Tot. M)"]) + 0.000001);
                    femaleRate[index] += (parseFloat(d["Totals, Female: Enrolled in SAME MAJOR (Tot. F)"]) + 0.000001) / (parseFloat(d["Totals, Female: Enrolled in DIFFERENT MAJOR (Tot. F)"]) + parseFloat(d["Totals, Female: Enrolled in SAME MAJOR (Tot. F)"]) + 0.000001);
                });
                if ($('#toolTip_vis3').length) {
                    document.getElementById("toolTip_vis3").outerHTML = '';
                }
                var tooltip3 = d3.select("#vis3_plot").append("div").attr("id", "toolTip_vis3");
                tooltip3.style("position", "relative")
                    .style("height", "auto")
                    .style("font-size", "14")
                    .style("background", "lightsteelblue")
                    .style("padding", "5px")
                    .style("border-radius", "8px")
                    .style("opacity", 0);



                var showData = []
                for (i = 0; i < 13; i++) {
                    maleRate[i] /= yearCount[i];
                    femaleRate[i] /= yearCount[i];
                    var year = ('' + (i + 2003)) + "-" + ('' + (i + 2004))
                    showData.push({ "year": year, "maleRate": maleRate[i], "femaleRate": femaleRate[i] });
                }

                //    console.log(maleRate);
                var x = d3.scaleBand()
                    .domain(showData.map(function(d) { return d.year; }))
                    .range([0, width])
                    .padding(0.13),

                    y = d3.scaleLinear().rangeRound([height, 0]).domain([0.5, 1]);

                function make_x_gridlines() {
                    return d3.axisBottom(x)
                        .ticks(5)
                }

                // gridlines in y axis function
                function make_y_gridlines() {
                    return d3.axisLeft(y)
                        .ticks(5)
                }

                // add the X gridlines
                svg.append("g")
                    .attr("class", "grid")
                    .attr("transform", "translate(0," + height + ")")
                    .call(make_x_gridlines()
                        .tickSize(-height)
                        .tickFormat("")
                    )
                    .attr("fill", "none");

                // add the Y gridlines
                svg.append("g")
                    .attr("class", "grid")
                    .call(make_y_gridlines()
                        .tickSize(-width)
                        .tickFormat("")
                    )
                svg.selectAll(".grid line")
                    .attr("stroke", "lightgrey")
                    .attr("stroke-opacity", 0.7);

                svg.selectAll(".dot")
                    .data(showData)
                    .enter()
                    .append("circle")
                    .attr("class", "male")
                    .attr("r", 3.5)
                    .attr("fill", "steelblue")
                    .attr("cx", function(d) { return x(d.year) + 29.3; })
                    .attr("cy", function(d) { return y(d.maleRate); })
                    .on("mouseover", function(d) {
                        //change dot color when      mouse hove over
                        d3.select(this)
                            .style("fill", "red")
                            .attr("r", 4.5);
                        //show tooltip
                        /*d3.select("#toolTip_vis3")
                            .style("left", d3.mouse(this)[0] - width)
                            .style("top", d3.mouse(this)[1] - height)
                            .style("display", "inline-block")
                            .style("opacity", .9)
                            .text('' + d.maleRate);

                        console.log("overman");*/




                    })
                    .on("mouseout", function(d) {
                        //change back the color
                        d3.select(this).style("fill", "steelblue")
                            .attr("r", 3.5);
                        //tooltip3.style("display", "none");



                    })
                    .on("click", function(d) {
                        //change back the color
                        $("#vis3_plot").fadeOut(500);
                        vis3_detail(d.year, "male", d.maleRate);

                    });

                var line = d3.line()
                    .x(function(d) { return x(d.year) + 29.3; })
                    .y(function(d) { return y(d.maleRate); });

                svg.append("path")
                    .datum(showData)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 1.5)
                    .attr("d", line)
                    .attr("data-legend", "Male");

                var line = d3.line()
                    .x(function(d) { return x(d.year) + 29.3; })
                    .y(function(d) { return y(d.femaleRate); });

                svg.selectAll(".dot")
                    .data(showData)
                    .enter()
                    .append("circle")
                    .attr("class", "female")
                    .attr("r", 3.5)
                    .attr("fill", "orange")
                    .attr("cx", function(d) { return x(d.year) + 29.3; })
                    .attr("cy", function(d) { return y(d.femaleRate); })
                    .on("mouseover", function(d) {
                        //change dot color when mouse hove over
                        d3.select(this).style("fill", "red")
                            .attr("r", 4.5);

                        //show tooltip
                        /*d3.select("#toolTip_vis3")
                            .style("left", d3.mouse(this)[0] - width)
                            .style("top", d3.mouse(this)[1] - height)
                            .style("display", "inline-block")
                            .style("opacity", .9)
                            .text('' + d.femaleRate);

                        console.log("overwoman");*/


                    })
                    .on("mouseout", function(d) {
                        //change back the color
                        d3.select(this).style("fill", "orange")
                            .attr("r", 3.5);
                        //d3.select("#toolTip_vis3").style("display", "none");
                        //console.log("outwoman");


                    })
                    .on("click", function(d) {
                        //change back the color
                        $("#vis3_plot").fadeOut(500);

                        vis3_detail(d.year, "female", d.maleRate);

                    });


                svg.append("path")
                    .datum(showData)
                    .attr("fill", "none")
                    .attr("stroke", "orange")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 1.5)
                    .attr("d", line)
                    .attr("data-legend", "Female");


                svg.append("g")
                    .call(d3.axisBottom(x))
                    .attr("transform", "translate(0," + y(0.5) + ")");

                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("class", "label")
                    .text("Retention Ratio")
                    .attr("x", 5)
                    .attr("y", -5);

                var ordinal = d3.scaleOrdinal()
                    .domain(["Male", "Female"])
                    .range(["steelblue", "orange"]);

                //legend
                svg.append("g")
                    .attr("class", "legendOrdinal")
                    .attr("transform", "translate(20,20)");

                var legendOrdinal = d3.legendColor()
                    .shape("path", d3.symbol().type(d3.symbolTriangle).size(150)())
                    .shapePadding(10)
                    //use cellFilter to hide the "e" cell
                    .cellFilter(function(d) { return d.label !== "e" })
                    .scale(ordinal);

                svg.select(".legendOrdinal")
                    .call(legendOrdinal);




            });

        };
        document.getElementById("back_btn")
            .addEventListener("click", function(d) {
                $("vis3_detail").fadeOut(500);
                vis3();
                $("vis3_plot").fadeIn(500);
            });
        //vis3_detail();
        function vis3_detail(year, sex, rate) {

            var div = document.getElementById('vis3_detail_plot');
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }

            var margin = { top: 20, right: 20, bottom: 30, left: 60 },
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var svg = d3.select("#vis3_plot").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            d3.csv("/data/Major_changed.csv", function(data) {
                var gender = 0;
                if (sex == "female") gender = 1;
                var fields = [
                    ["Totals, Male: Enrolled in DIFFERENT MAJOR (Tot. M)", "Totals, Male: Enrolled in SAME MAJOR (Tot. M)",
                        "Freshmen, Male: Enrolled in DIFFERENT MAJOR (Fshm M)", "Freshmen, Male: Enrolled in SAME MAJOR (Fshm M)",
                        "Sophomores, Male: Enrolled in DIFFERENT MAJOR (Sph. M)", "Sophomores, Male: Enrolled in SAME MAJOR (Sph. M)"
                    ],
                    ["Totals, Female: Enrolled in DIFFERENT MAJOR (Tot. F)", "Totals, Female: Enrolled in SAME MAJOR (Tot. F)",
                        "Freshmen, Female: Enrolled in DIFFERENT MAJOR (Fshm F)", "Freshmen, Female: Enrolled in SAME MAJOR (Fshm F)",
                        "Sophomores, Female: Enrolled in DIFFERENT MAJOR (Sph. F)", "Sophomores, Female: Enrolled in SAME MAJOR (Sph. F)"
                    ]
                ];

                var declareDict = { "End of 1st Year": 0, "End of 2nd Year": 1, "Upon Enrollment": 2, "Other": 3 };
                var declarFields = ["End of 1st Year", "End of 2nd Year", "Upon Enrollment", "Other"];
                var count = new Array(4).fill(0),
                    freshmenRates = new Array(4).fill(0),
                    sophomoresRates = new Array(4).fill(0),
                    otherRates = new Array(4).fill(0);
                data.forEach(function(d) {
                    if (d["School Year"] != year)
                        return;
                    var index = declareDict[d["When do students typically declare their major?"]];
                    count[index]++;
                    freshmenRates[index] += (parseFloat(d[fields[gender][3]]) + 0.000001) / (parseFloat(d[fields[gender][2]]) + parseFloat(d[fields[gender][3]]) + 0.000001);
                    sophomoresRates[index] += (parseFloat(d[fields[gender][5]]) + 0.000001) / (parseFloat(d[fields[gender][4]]) + parseFloat(d[fields[gender][5]]) + 0.000001);
                    otherRates[index] += (parseFloat(d[fields[gender][1]]) - parseFloat(d[fields[gender][3]]) - parseFloat(d[fields[gender][5]]) + 0.000001) /
                        (parseFloat(d[fields[gender][1]]) + parseFloat(d[fields[gender][0]]) - (parseFloat(d[fields[gender][2]]) + parseFloat(d[fields[gender][3]])) - (parseFloat(d[fields[gender][4]]) + parseFloat(d[fields[gender][5]])) + 0.000001);
                });
                var showData = [];
                for (i = 0; i < 4; i++) {
                    showData.push({
                        "label": declarFields[i],
                        "totalRetention": rate, // TODO
                        "freshmenRetention": freshmenRates[i] / count[i],
                        "sophomoresRates": sophomoresRates[i] / count[i],
                        "otherRates": otherRates[i] / count[i]
                    });

                }
                var margin = { top: 20, right: 20, bottom: 30, left: 60 },
                    width = 960 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                var svg = d3.select("#vis3_detail_plot").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var x0 = d3.scaleBand()
                    .rangeRound([0, width])
                    .paddingInner(0.1);

                var x1 = d3.scaleBand()
                    .padding(0.05);

                var y = d3.scaleLinear()
                    .rangeRound([height, 0]);

                var z = d3.scaleOrdinal(d3.schemeCategory10);

                var keys = ["totalRetention", "freshmenRetention", "sophomoresRates", "otherRates"];

                x0.domain(showData.map(function(d) { return d.label; }));
                x1.domain(keys).rangeRound([0, x0.bandwidth()]);
                y.domain([0.5, 1.0]);

                svg.append("g")
                    .selectAll("g")
                    .data(showData)
                    .enter().append("g")
                    .attr("transform", function(d) { return "translate(" + x0(d.label) + ",0)"; })
                    .selectAll("rect")
                    .data(function(d) { return keys.map(function(key) { return { key: key, value: d[key] }; }); })
                    .enter().append("rect")
                    .attr("x", function(d) { return x1(d.key); })
                    .attr("y", function(d) {
                        if (isNaN(d.value)) return y(0.5);
                        else
                            return y(d.value);
                    })
                    .attr("width", x1.bandwidth())
                    .attr("height", function(d) {
                        if (isNaN(d.value)) return height - y(0.5);
                        else
                            return height - y(d.value);
                    })
                    .attr("fill", function(d) { return z(d.key); });

                svg.append("g")
                    .call(d3.axisBottom(x0))
                    .attr("transform", "translate(0," + y(0.5) + ")");

                svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("text")
                    .attr("class", "label")
                    .text("Retention Ratio")
                    .attr("x", 5)
                    .attr("y", -5);

                var ordinal = d3.scaleOrdinal()
                    .domain(["Total", "Freshmen", "Sophomores", "Other"])
                    .range(d3.schemeCategory10);

                //legend
                svg.append("g")
                    .attr("class", "legendOrdinal")
                    .attr("transform", "translate(20,20)");

                var legendOrdinal = d3.legendColor()
                    .shape("path", d3.symbol().type(d3.symbolSquare).size(150)())
                    .shapePadding(10)
                    //use cellFilter to hide the "e" cell
                    .cellFilter(function(d) { return d.label !== "e" })
                    .scale(ordinal);

                svg.select(".legendOrdinal")
                    .call(legendOrdinal);
            });

            $("#vis3_detail").fadeIn(1000);


        };
        vis4();

        function vis4() {
            d3.csv("/data/race_total_no_missing.csv", function(data) {
                var yearDict = {
                    "2003-2004": 0,
                    "2004-2005": 1,
                    "2005-2006": 2,
                    "2006-2007": 3,
                    "2007-2008": 4,
                    "2008-2009": 5,
                    "2009-2010": 6,
                    "2010-2011": 7,
                    "2011-2012": 8,
                    "2012-2013": 9,
                    "2013-2014": 10,
                    "2014-2015": 11,
                    "2015-2016": 12
                };
                var total = [Array(13).fill(0), Array(13).fill(0)],
                    asian = [Array(13).fill(0), Array(13).fill(0)],
                    black = [Array(13).fill(0), Array(13).fill(0)],
                    hispanics = [Array(13).fill(0), Array(13).fill(0)],
                    hawaiian = [Array(13).fill(0), Array(13).fill(0)],
                    twomore = [Array(13).fill(0), Array(13).fill(0)],
                    white = [Array(13).fill(0), Array(13).fill(0)];

                data.forEach(function(d) {
                    var index = yearDict[d["School Year"]];
                    asian[0][index] += parseFloat(d["Totals, Male: Asian (Tot. M)"]);
                    asian[1][index] += parseFloat(d["Totals, Female: Asian (Tot. F)"]);
                    black[0][index] += parseFloat(d["Totals, Male: Black/African American (Tot. M)"]);
                    black[1][index] += parseFloat(d["Totals, Female: Black/African American (Tot. F)"]);
                    hispanics[0][index] += parseFloat(d["Totals, Male: Hispanics of any race (Tot. M)"]);
                    hispanics[1][index] += parseFloat(d["Totals, Female: Hispanics of any race (Tot. F)"]);
                    hawaiian[0][index] += parseFloat(d["Totals, Male: Native Hawaiian/Other Pacific Islander (Tot. M)"]);
                    hawaiian[1][index] += parseFloat(d["Totals, Female: Native Hawaiian/Other Pacific Islander (Tot. F)"]);
                    twomore[0][index] += parseFloat(d["Totals, Male: Two or more races (Tot. M)"]);
                    twomore[1][index] += parseFloat(d["Totals, Female: Two or more races (Tot. F)"]);
                    white[0][index] += parseFloat(d["Totals, Male: White (Tot. M)"]);
                    white[1][index] += parseFloat(d["Totals, Female: White (Tot. F)"]);
                });
                console.log(asian);

                var yearData = [],
                    genderData = [],
                    raceData = [];
                for (i = 0; i < 13; i++) {
                    var year = ('' + (i + 2003)) + "-" + ('' + (i + 2004));
                    var maletotal = asian[0][i] + black[0][i] + hispanics[0][i] + hawaiian[0][i] + twomore[0][i] + hispanics[0][i],
                        femaletotal = asian[1][i] + black[1][i] + hispanics[1][i] + hawaiian[1][i] + twomore[1][i] + hispanics[1][i];

                    yearData.push({
                        "year": year,
                        "value": maletotal + femaletotal
                    });
                    genderData.push({
                        "year": year,
                        "male": maletotal,
                        "female": femaletotal
                    });
                    raceData.push([
                        { "race": "Asian", "value": asian[0][i] + asian[1][i] },
                        { "race": "Black", "value": black[0][i] + black[1][i] },
                        { "race": "Hispanics", "value": hispanics[0][i] + hispanics[1][i] },
                        { "race": "Hawaiian", "value": hawaiian[0][i] + hawaiian[1][i] },
                        { "race": "Two or More Races", "value": twomore[0][i] + twomore[1][i] },
                        { "race": "Whte", "value": white[0][i] + white[1][i] }
                    ]);
                }
                console.log(raceData);

                var margin = { top: 20, right: 20, bottom: 30, left: 0 },
                    width = 480 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                var svg = d3.select("#vis4_plot").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", 'translate(' + (width / 2 + 50) +
                        ',' + (height / 2) + ')');

                var radius = Math.min(width, height) / 2;

                var pie = d3.pie()
                    .value(function(d) { return d.value; })
                    .sort(null);

                // contructs and arc generator. This will be used for the donut. The difference between outer and inner
                // radius will dictate the thickness of the donut
                var arc = d3.arc()
                    .outerRadius(radius * 0.8)
                    .innerRadius(radius * 0.6);


                var color = d3.scaleOrdinal(d3.schemeCategory20);

                var path = svg
                    .selectAll('path')
                    .data(pie(yearData))
                    .enter().append('path')
                    .attr("class", "arc")
                    .attr('fill', function(d) { return color(d.data.year); })
                    .attr('d', arc)
                    .attr("year", function(d) { return d.data.year; })
                    .attr("clicked", false)
                    .style("opacity", 0.4)
                    .on("mouseover", function(d) {
                        d3.select(this)
                            .style("opacity", 1.0);
                    })
                    .on("mouseout", function(d) {
                        var arcpart = d3.select(this);
                        if (arcpart.attr("clicked") == "yes") {

                        } else {
                            arcpart.style("opacity", 0.4);
                        }
                    })
                    .on("click", function(d) {
                        svg.selectAll('.arc')
                            .style("opacity", 0.4)
                            .attr("clicked", "no")
                            .attr('d', arc);

                        var bigarc = d3.arc()
                            .outerRadius(radius * 0.87)
                            .innerRadius(radius * 0.67);

                        d3.select(this)
                            .style("opacity", 1.0)
                            .attr("clicked", "yes")
                            .attr('d', bigarc);

                        if ($('#raceChart').length) {
                            $('#raceChart').fadeOut(500);
                            document.getElementById("raceChart").outerHTML = '';
                        }

                        var svg2 = d3.select("#vis4_plot").append("svg")
                            .attr("width", width + margin.left + margin.right + 100)
                            .attr("height", height + margin.top + margin.bottom)
                            .attr("id", "raceChart")
                            .append("g")
                            .attr("transform", 'translate(' + (width / 2 + 150) +
                                ',' + (height / 2) + ')');
                        var raceColor = d3.scaleOrdinal().range(["yellow", "black", "Grey", "Blue", "Green", "Red"])

                        var path = svg2
                            .selectAll('path')
                            .data(pie(raceData[yearDict[d3.select(this).attr("year")]]))
                            .enter().append('path')
                            .attr("class", "arc")
                            .attr('fill', function(d) { return raceColor(d.data.race); })
                            .attr('d', arc)
                            .attr("clicked", false)
                            .style("opacity", 0.7)
                            .on("mouseover", function(d) {
                                d3.select(this)
                                    .style("opacity", 1.0);
                            })
                            .on("mouseout", function(d) {
                                d3.select(this)
                                    .style("opacity", 0.7);
                            })
                        var ordinal2 = d3.scaleOrdinal()
                            .domain(["Asian","Black","Hispanics","Hawaiian","Two or More Races","White"])
                            .range(raceColor.range());

                        //legend
                        svg2.append("g")
                            .attr("class", "legendOrdinal")
                            .attr("transform", "translate(-270,-200)");

                        var legendOrdinal2 = d3.legendColor()
                            .shape("path", d3.symbol().type(d3.symbolSquare).size(150)())
                            .shapePadding(10)
                            //use cellFilter to hide the "e" cell
                            .cellFilter(function(d) { return d.label !== "e" })
                            .scale(ordinal2);

                        svg2.select(".legendOrdinal")
                            .call(legendOrdinal2);
                        $('#raceChart').fadeOut(0);
                        $('#raceChart').fadeIn(500);

                    });

                var ordinal = d3.scaleOrdinal()
                    .domain(Object.keys(yearDict))
                    .range(d3.schemeCategory20);

                //legend
                svg.append("g")
                    .attr("class", "legendOrdinal")
                    .attr("transform", "translate(-270,-200)");

                var legendOrdinal = d3.legendColor()
                    .shape("path", d3.symbol().type(d3.symbolSquare).size(150)())
                    .shapePadding(10)
                    //use cellFilter to hide the "e" cell
                    .cellFilter(function(d) { return d.label !== "e" })
                    .scale(ordinal);

                svg.select(".legendOrdinal")
                    .call(legendOrdinal);


            });

        }
        </script>
</body>

</html>